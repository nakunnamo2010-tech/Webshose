// This file is the main JavaScript for the app.
// It initializes Firebase, handles authentication, and manages Firestore data.

// The Firebase SDKs for authentication and Firestore.
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const leaderboardContainer = document.getElementById('leaderboard');
const publicLeaderboardList = document.getElementById('public-leaderboard-list');
const personalBestList = document.getElementById('personal-best-list');
const scoreInput = document.getElementById('score-input');
const saveScoreBtn = document.getElementById('save-score-btn');
const userIdDisplay = document.getElementById('user-id-display');
const errorMessageDisplay = document.getElementById('error-message');
const authStatusDisplay = document.getElementById('auth-status');

// This is the Firebase configuration. It is an object containing the keys for your Firebase project.
// This is automatically provided by the Canvas environment.
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
// This is the current application ID, also provided by Canvas.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
// This is the initial authentication token, provided by Canvas.
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let db;
let auth;
let userId = null;

// Function to display an error message on the screen.
function displayError(message) {
    console.error(message);
    if (errorMessageDisplay) {
        errorMessageDisplay.textContent = `ข้อผิดพลาด: ${message}`;
        errorMessageDisplay.style.display = 'block';
    }
}

// Function to update the UI with the authentication status.
function updateAuthStatus(status, user) {
    if (authStatusDisplay) {
        authStatusDisplay.textContent = `สถานะการรับรองความถูกต้อง: ${status}`;
    }
    if (userIdDisplay && user) {
        userIdDisplay.textContent = `ID ผู้ใช้ปัจจุบัน: ${user.uid}`;
    }
}

// Initialize Firebase and handle authentication.
async function initializeFirebase() {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Listen for authentication state changes to handle user sign-in.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                updateAuthStatus("เข้าสู่ระบบแล้ว", user);
                console.log(`ผู้ใช้เข้าสู่ระบบ: ${userId}`);

                // Now that the user is authenticated, we can safely listen to Firestore.
                await listenToFirestoreData();
            } else {
                updateAuthStatus("ยังไม่ได้เข้าสู่ระบบ", null);
                userId = null;
                console.log("ผู้ใช้ออกจากระบบหรือยังไม่ได้เข้าสู่ระบบ");
            }
        });

        // Sign in the user using the custom token provided by the environment.
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
            console.log("เข้าสู่ระบบด้วยโทเค็นที่กำหนดเองสำเร็จ");
        } else {
            await signInAnonymously(auth);
            console.log("เข้าสู่ระบบแบบไม่ระบุชื่อสำเร็จ");
        }
    } catch (error) {
        displayError(`เกิดข้อผิดพลาดในการเริ่มต้น Firebase: ${error.message}`);
    }
}

// Function to listen for changes to the Firestore data.
async function listenToFirestoreData() {
    if (!userId) {
        console.error("ผู้ใช้ยังไม่ได้เข้าสู่ระบบ, ไม่สามารถฟังข้อมูลได้.");
        return;
    }

    try {
        // --- ส่วนที่ 1: จัดการคะแนนส่วนตัว ---
        const userScoresRef = collection(db, `artifacts/${appId}/users/${userId}/scores`);
        const userScoresQuery = query(userScoresRef);
        onSnapshot(userScoresQuery, (querySnapshot) => {
            personalBestList.innerHTML = '';
            let scores = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                scores.push({
                    id: doc.id,
                    score: data.score,
                    timestamp: data.timestamp
                });
            });

            // Sort scores in descending order.
            scores.sort((a, b) => b.score - a.score);

            scores.forEach(score => {
                const listItem = document.createElement('li');
                listItem.textContent = `คะแนน: ${score.score} | เมื่อ: ${new Date(score.timestamp).toLocaleString()}`;
                personalBestList.appendChild(listItem);
            });
            console.log("อัปเดตข้อมูลส่วนตัวแล้ว");
        });

        // --- ส่วนที่ 2: จัดการกระดานผู้นำสาธารณะ ---
        const publicScoresRef = collection(db, `artifacts/${appId}/public/data/scores`);
        const publicScoresQuery = query(publicScoresRef);
        onSnapshot(publicScoresQuery, (querySnapshot) => {
            publicLeaderboardList.innerHTML = '';
            let scores = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                scores.push({
                    id: doc.id,
                    score: data.score,
                    userId: data.userId // Ensure userId is available in the public data
                });
            });

            // Sort scores in descending order.
            scores.sort((a, b) => b.score - a.score);

            scores.forEach((score, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `อันดับ ${index + 1}: ${score.score} โดย ${score.userId}`;
                publicLeaderboardList.appendChild(listItem);
            });
            console.log("อัปเดตข้อมูลสาธารณะแล้ว");
        });

    } catch (error) {
        displayError(`ข้อผิดพลาดในการฟังข้อมูล Firestore: ${error.message}`);
    }
}

// Function to save a new score to Firestore.
async function saveScore() {
    if (!userId) {
        displayError("โปรดรอให้ผู้ใช้เข้าสู่ระบบก่อนที่จะบันทึกคะแนน");
        return;
    }

    const score = parseInt(scoreInput.value, 10);
    if (isNaN(score) || score < 0) {
        displayError("โปรดใส่คะแนนที่ถูกต้อง");
        return;
    }

    const newScore = {
        score: score,
        timestamp: Date.now(),
        userId: userId
    };

    try {
        // Save to the user's private collection.
        const userDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/scores`));
        await setDoc(userDocRef, newScore);

        // Save to the public leaderboard.
        const publicDocRef = doc(collection(db, `artifacts/${appId}/public/data/scores`));
        await setDoc(publicDocRef, newScore);

        console.log("บันทึกคะแนนสำเร็จ!");
        scoreInput.value = '';
    } catch (error) {
        displayError(`ข้อผิดพลาดในการบันทึกคะแนน: ${error.message}`);
    }
}

// Attach event listener to the save button.
if (saveScoreBtn) {
    saveScoreBtn.addEventListener('click', saveScore);
}

// Start the app by initializing Firebase.
initializeFirebase();
