<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตัวอย่างการดึงข้อมูลจาก Firebase Realtime Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-2xl font-bold text-gray-800 text-center mb-4">ค่าแรงดันไฟฟ้าจาก ESP32</h1>
        <div class="text-lg text-gray-600 text-center mb-6">
            แสดงค่าแรงดันไฟฟ้าล่าสุดที่ได้จาก Firebase Realtime Database
        </div>
        <div class="bg-blue-100 border border-blue-200 rounded-lg p-6 text-center shadow-inner">
            <div class="text-base font-medium text-blue-800">ค่าแรงดันไฟฟ้า:</div>
            <div id="voltage-value" class="text-4xl md:text-5xl font-extrabold text-blue-900 mt-2">
                กำลังเชื่อมต่อ...
            </div>
            <div class="text-2xl font-semibold text-blue-700 mt-1">V (โวลต์)</div>
        </div>
        <div id="user-info" class="text-xs text-gray-500 text-center mt-6">
            <!-- ข้อมูลผู้ใช้จะแสดงที่นี่ -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // นำเข้าโมดูลที่จำเป็นจาก Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // ตัวแปรส่วนกลางที่ Canvas จัดเตรียมไว้
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ตัวแปรสำหรับใช้งาน Firebase
        let app, db, auth;
        let userId = null;

        // อ้างอิงถึง UI elements
        const voltageValue = document.getElementById('voltage-value');
        const userInfo = document.getElementById('user-info');

        // ฟังก์ชันสำหรับเริ่มต้น Firebase
        async function initializeFirebase() {
            try {
                if (!firebaseConfig) {
                    throw new Error("Firebase config is missing.");
                }

                // เริ่มต้น Firebase App
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);

                // เริ่มต้นการตรวจสอบสถานะการล็อกอิน
                setupAuthListener();

                // ล็อกอินด้วย token ที่ได้รับมา หรือแบบ anonymous ถ้าไม่มี
                // โค้ดนี้จะใช้ __initial_auth_token ที่ Canvas จัดเตรียมไว้
                // ถ้าไม่มี จะใช้การล็อกอินแบบไม่ระบุตัวตน (anonymous)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                console.log("Firebase initialized successfully.");

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                voltageValue.textContent = "เกิดข้อผิดพลาดในการเชื่อมต่อ: " + error.message;
            }
        }

        // ฟังก์ชันสำหรับรับฟังการเปลี่ยนแปลงสถานะการล็อกอิน (ส่วนสำคัญ)
        function setupAuthListener() {
            // ฟังก์ชันนี้จะถูกเรียกเมื่อสถานะการล็อกอินเปลี่ยน
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // ผู้ใช้ล็อกอินแล้ว
                    userId = user.uid;
                    console.log("User signed in with UID:", userId);
                    userInfo.textContent = `User ID: ${userId}`;
                    
                    // เรียกฟังก์ชันสำหรับดึงข้อมูล
                    fetchVoltageData();

                } else {
                    // ผู้ใช้ไม่ได้ล็อกอิน
                    console.log("User is signed out.");
                    voltageValue.textContent = "ไม่ได้ล็อกอิน";
                }
            });
        }

        // ฟังก์ชันสำหรับดึงข้อมูลจาก Realtime Database แบบเรียลไทม์
        function fetchVoltageData() {
            // ตรวจสอบให้แน่ใจว่า Firebase และผู้ใช้พร้อมใช้งาน
            if (!db || !userId) {
                console.log("Database or user ID not available yet.");
                return;
            }

            // นี่คือ Path ที่คุณต้องแก้ไขให้ตรงกับโครงสร้างข้อมูลของคุณ
            // ถ้าคุณต้องการใช้ path อื่น ๆ เช่น "sensor/voltage" ให้เปลี่ยนบรรทัดนี้
            const voltagePath = ref(db, 'voltage');

            // ใช้ onValue เพื่อฟังการเปลี่ยนแปลงของข้อมูลแบบเรียลไทม์
            onValue(voltagePath, (snapshot) => {
                const data = snapshot.val();
                if (data !== null) {
                    // แสดงข้อมูล
                    voltageValue.textContent = `${data}`;
                } else {
                    voltageValue.textContent = "ไม่มีข้อมูลที่ path นี้";
                    console.log("No data available at the specified path.");
                }
            }, (error) => {
                console.error("Error fetching data:", error);
                voltageValue.textContent = "เกิดข้อผิดพลาดในการดึงข้อมูล: " + error.message;
            });
        }

        // เริ่มต้นการทำงานทั้งหมด
        initializeFirebase();

    </script>
</body>
</html>
